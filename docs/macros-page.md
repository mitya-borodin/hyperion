# Макросы

## Макрос для пользователя

С точки зрения пользователя, макрос это готовая программа, которую он выбирает в магазине макросов, и может запустить 1 или несколько экземпляров с разными настройками.

Некоторые макросы нельзя запускать больше одного экземпляра, за соблюдением этой договоренности следит платформа, которая позволяет запускать и останавливать макросы. О чем сообщается пользователю в GUI.

Для настройки макросов пользователь может выбрать контролы установленных в систему устройств и макросов так как доступные для использования выходные данны макросов, будут представлены как устройства с контролами, где идентификатор устройства это `macros.id`, а идентификатор контрола `macros.output[i].id`.

Запущенный макрос представляется как карточка с краткой информацией, где можно увидеть исправен ли он, его состояние, выходные параметры, время последней активности с цветовым индикатором давности последней активности.

При помощи карточки запущенного макроса можно, остановить, удалить, изменить настройки, изменить текущее состояние, изменить разметку макроса.

В случае если у макроса есть выходные данные, то они отображаются на странице устройств, переданные как экземпляры [HyperionDevice](../src/domain/hyperion-device.ts).

Используя доступные в [магазине макросы](../src/domain/macroses/macros-showcase.ts), пользователь может конфигурировать произвольные сценарии, собирая их из тех макросов которые доступны, с учетом внутренних правил создания экземпляров макросов.

## Макрос для разработчика

С точки зрения разработчика макрос это класс, экземпляр которого работает в памяти используя настройки сохраненные в БД.

Макрос хранит в БД только настройки, которые позволяют понять, какие макросы были включены и с какими настройками.

При запуске сервиса, Происходит чтение всей таблицы с настройками и запускаются соответствующие макросы с соответствующими настройками.

Далее вся работа происходит в памяти, запущенного nodejs процесса.

Для `multi-tenant` решения, удобно запускать процесс с ограничением по RAM и CPU в рамках того, что необходимо для работы сервиса (будет установлено эмпирически). Но база данных для хранения настроек и исторических данных, будет одна на всех, данные будут разделяться через `tenant-id`.

Это удобно, потому что, активность пользователя почти никак не влияет на производительность сервиса, и мы знаем максимально возможное потребление памяти и CPU для самой "жирной конфигурации устройств", и вся работа происходит не прерывно, получая данные от контроллера.

Единственное, о чем нам нужно беспокоиться в `multi-tenant` системе, это о том, как разделить доступ к нужным процессам по пользователям, это будет решено на языке `go`, как часть системы работы с пользователем и запущенных для него процессов.

Оптимизация и масштабирование БД, становится отдельной задачей, где необходимо работать с кластером PostgreSQL, обеспечивая быструю вставку исторических данных, чтение/запись настроек, и текущего состояния каждого контрола.

С логической точки зрения, макрос это законченная программа, которая может работать как полностью самостоятельно, так и зависеть от контролов других макросов.

Все контролы как в устройствах так и в макросах, могут быть `только для чтения` и `запись/чтение`.

## Макросы и система в целом

Макросы это основа системы, так как они позволяют **НЕ** разрабатывать для каждого частного случая новую реализацию, которая на 80% похожа на предыдущий частный случай.

При помощи макросов, мы сможем повторно использовать хорошо протестированный и проверенный в бою код на каждой последующей установке.

Установка - это монтаж и пуска/наладка на конкретном частном/многоквартирном доме, предприятии.

Система может быть установлена как на частный ПК, с настройкой всех внешних интеграций, либо подключена к облачной системе, где уже предусмотрены все необходимые интеграции.
