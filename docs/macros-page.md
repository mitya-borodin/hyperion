# Макросы

## Макрос для пользователя

С точки зрения пользователя, макрос это готовая программа, которую он выбирает в магазине макросов, и может запустить 1 или несколько экземпляров с разными настройками.

Некоторые макросы нельзя запускать больше одного экземпляра, за соблюдением этой договоренности следит платформа, которая позволяет запускать и останавливать макросы. О чем сообщается пользователю в GUI.

Для настройки макросов пользователь может выбрать контролы установленных в систему устройств и макросов так как доступные для использования выходные данны макросов, будут представлены как устройства с контролами, где идентификатор устройства это `macros.id`, а идентификатор контрола `macros.output[i].id`.

Запущенный макрос представляется как карточка с краткой информацией, где можно увидеть исправен ли он, его состояние, выходные параметры, время последней активности с цветовым индикатором давности последней активности.

При помощи карточки запущенного макроса можно, остановить, удалить, изменить настройки, изменить текущее состояние, изменить разметку макроса.

В случае если у макроса есть выходные данные, то они отображаются на странице устройств, переданные как экземпляры [HyperionDevice](../src/domain/hyperion-device.ts).

Используя доступные в [магазине макросы](../src/domain/macroses/macros-showcase.ts), пользователь может конфигурировать произвольные сценарии, собирая их из тех макросов которые доступны, с учетом внутренних правил создания экземпляров макросов.

## Макрос для разработчика

С точки зрения разработчика макрос это класс, экземпляр которого работает в памяти используя настройки сохраненные в БД.

Макрос хранит в БД только настройки, которые позволяют понять, какие макросы были включены и с какими настройками.

При запуске сервиса, Происходит чтение всей таблицы с настройками и запускаются соответствующие макросы с соответствующими настройками.

Далее вся работа происходит в памяти, запущенного nodejs процесса.

Для `multi-tenant` решения, удобно запускать процесс с ограничением по RAM и CPU в рамках того, что необходимо для работы сервиса (будет установлено эмпирически). Но база данных для хранения настроек и исторических данных, будет одна на всех, данные будут разделяться через `tenant-id`.

Это удобно, потому что, активность пользователя почти никак не влияет на производительность сервиса, и мы знаем максимально возможное потребление памяти и CPU для самой "жирной конфигурации устройств", и вся работа происходит не прерывно, получая данные от контроллера.

Единственное, о чем нам нужно беспокоиться в `multi-tenant` системе, это о том, как разделить доступ к нужным процессам по пользователям, это будет решено на языке `go`, как часть системы работы с пользователем и запущенных для него процессов.

Оптимизация и масштабирование БД, становится отдельной задачей, где необходимо работать с кластером PostgreSQL, обеспечивая быструю вставку исторических данных, чтение/запись настроек, и текущего состояния каждого контрола.

С логической точки зрения, макрос это законченная программа, которая может работать как полностью самостоятельно, так и зависеть от контролов других макросов.

Все контролы как в устройствах так и в макросах, могут быть `только для чтения` и `запись/чтение`.

## Макросы и система в целом

Макросы - это основа системы, так как они позволяют **НЕ** разрабатывать для каждого частного случая новую реализацию, которая на 80% похожа на предыдущий частный случай.

При помощи макросов, мы сможем повторно использовать хорошо протестированный и `"проверенный в бою код"` на каждой последующей установке.

Установка - это монтаж и пуска/наладка на конкретном частном/многоквартирном доме, предприятии.

Система может быть установлена как на частный ПК, с настройкой всех внешних интеграций, либо подключена к облачной системе, где уже предусмотрены все необходимые интеграции.

## Взаимодействие между макросами

Существую ситуации когда необходимо наладить взаимодействие между несколькими макросами, например управление климатом.

Для управления климатом необходимо управлять:

- Отоплением
- Вентиляцией
- Увлажнением
- Кондиционированием

Для управления водоснабжением нужно уметь управлять:

- Отоплением
- Насосом
- Системой от протечек

Для реализации комфортного пользования санузлами нужно управлять:

- Водоснабжением
- Полотенце сушителем
- Освещением
- Вентиляцией

И таких комбинаций может быть множество, невозможно учесть все сценарии использования.

При появлении сценариев использования будут добавляться макросы которые используют устройства и другие макросы для работы.

В таких условиях неизбежно будут возникать гонки состояний.

Допустим макросу `отопление` нужно выставить на котле температуру 40 градусов, макросу `водоснабжение` нужно выставить 75 градусов, макросу `вентиляция` нужно выставить температуру 60 градусов, в такой ситуации нужно собрать все запросы и по итогу выставить значение для котла.

Для решения этой проблемы, нужно ввести ещё одну сущность для управления конкретными ресурсами, и эта сущность называется [мультиплексор](<https://ru.wikipedia.org/wiki/Мультиплексор_(электроника)>).

В нашем случае `мультиплексор` будет иметь несколько входов, и один выход, входами будут управляющие сигналы различных макросов, а выходным сигналом будет изменения конкретного контрола.

## Мультиплексор

См. [мультиплексор](<https://ru.wikipedia.org/wiki/Мультиплексор_(электроника)>).

В нашей системе будут реализованы мультиплексоры:

- Числовой
  - Принимает на вход несколько `float`, возвращает один `float` в зависимости от настроек.
    - Вернуть максимальное.
    - Вернуть среднее.
    - Вернуть минимальное.
    - Вернуть значение с указанной задержкой.
- Логический
  - Принимает на вход несколько `boolean`, возвращает один `boolean` в зависимости от настроек.
    - Использовать `OR`
    - Использовать `AND`
- Логически-числовой
  - Принимает на вход несколько `float`, возвращает один `boolean` в зависимости от настроек.
    - Если максимальное больше заданного значения.
    - Если среднее больше заданного значения.
    - Если минимальное меньше заданного значения.

Результат работы `мультиплексора` - это изменение выбранного контрола, либо создание [HyperionDevice](../src/domain/hyperion-device.ts) с одним или несколькими контролами, которым соответствует результат работы `мультиплексора`.

Таким образом у любого `мультиплексора` есть настройка `readonly`, `write`.

Мультиплексоры создаются таким же образом как и макросы но находятся на отдельной странице, так же как устройства и макросы, но все производные устройства имеют типа [HyperionDevice](../src/domain/hyperion-device.ts).

## Производные устройства

Производные [HyperionDevice](../src/domain/hyperion-device.ts) - это выходные `readonly` данные макроса и/или выходные `readonly` данные мультиплексора.

В случаях когда макрос или мультиплексор пишет в какой-то контрол, данные которые он пишет отображены в самом макросе или мультиплексоре.

Производные [HyperionDevice](../src/domain/hyperion-device.ts), нужны только для того, чтобы ими могли воспользоваться другие макросы или мультиплексоры.

## Пресеты

Пресет - это готовый набор макросов и мультиплексоров и настроек взаимодействия между ними, который позволяет одной процедурой запустить установку какого либо заранее заготовленного сценария использования автоматизации.

Использование пресетов, позволяет ускорить пусконаладку типовых решений.

После каждой конечной установки, составляется предложение по конфигурации пресета.
