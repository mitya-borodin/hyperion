# Devices page

## Введение

Все взаимодействие с устройствами подключенными к контроллеру происходит в рамках протокола [MQTT](https://wirenboard.com/wiki/index.php/MQTT).

MQTT позволяет:

- Получить мета информацию о устройствах.
- Получить мета информацию о контролах.
- Получить текущее состояние контролов.
- Изменить состояние контрола.

Hyperion прослушивать все MQTT сообщения, и формирует из них объект [HyperionDevice](../src/domain/hyperion-device.ts) на уровне приложения.

Эти объекты используются для:

- Хранения текущего состояния устройства в БД.
- Ведения истории изменений состояний контролов.
- Удобного представления устройства на уровне приложения.
- Передачи данных на FE при помощи слоя [GraphQL](../src/interfaces/http/graphql/schema.graphql#L142), и типа `Device`.
- Создания макросов.

FE коммуницирует только с [GraphQL](../src/interfaces/http/graphql/schema.graphql#L229), и не знает каким образом происходит преобразование из MQTT сообщений в [HyperionDevice](../src/domain/hyperion-device.ts), и обратно.

Актуальные данные FE получается из подписки [GraphQL Subscription](../src/interfaces/http/graphql/schema.graphql#L260).

На странице устройств мы видим навигацию, фильтр по устройствам, список устройств в виде grid системы, и пагинацию по страницам, если это нужно.

Все данные на этой странице подтягиваются в реальном времени, через `GraphQL subscription`, по верх `web socket` соединения.

## Функциональное назначение

В рамках понятий проекта, устройства и контролы wirenboard это некие абстрактные вещи. Например устройство `wb-msw-v3_123`, контрол `Air Quality (VOC)`, или устройство `0x00158d00096964ea`, контрол `temperature` и так далее.

Но в рамках понятия проекта "умного" дома мы оперируем понятиями `качество воздуха в спальне`, `температура поверхности пола в кабинете`.

Для того, чтобы связать абстрактные идентификаторы устройств и контролов с понятиями из проекта "умного" дома, необходимо в объекты [HyperionDevice](../src/domain/hyperion-device.ts), добавить информацию в `markup` и `labels` о том, что это устройство и его контрол(ы) означают, в рамках проекта "умного" дома.

Но если мы будем `хардкодить` эти связи для каждой инсталляции мы получим `легаси` решение сразу же после того как оно будет запущено. Так как для изменения какого либо параметра придется прибегать к услугам программиста.

Для решения этой задачи, нам требуется GUI который позволит размечать устройства без вмешательство в код.

После того как все устройства и их контролы размечены появляется возможность конфигурировать [макросы](./macros-page.md).

## Навигация

См. [navigation](./navigation.md).

## Фильтр

См. [filter](./filter.md).

## Устройства

Представляют из себя карточки `устройств`, каждая такая карточка представляет объект [HyperionDevice](../src/domain/hyperion-device.ts).

### Карточка устройства

На лицевой части карточки выводится часть информации, которая нужна для поиска устройства в ручную.

#### Заголовок

Заголовок является важнейшей частью карточки он состоит из трех элементов: иконка, первая и вторая строка.

Для составления заголовка используются поля объекта [HyperionDevice](../src/domain/hyperion-device.ts): `title`, `markup.title`, `id`, `driver`.

Сам заголовок должен быть ручкой для перетаскивания карточки устройства по порядку следования в гриде.

Заголовок должен быть выделен цветом, если задано поле `markup.color`.

##### Иконка

Иконка выбирается в зависимости от типа устройства, тип устройства это захардкоженная строка, котрой соответствует иконка.

Например тип устройства `wb-msw-v3` и этой строке соответствует нужная иконка, и мы смотрим, есть ли в `id` устройств (`wb-msw-v3_123`, `wb-msw-v3_108`, `0x00158d00091b57e9`, `wb-adc`, `wb-mr6cu_69`) вхождение каждой имеющейся иконки, если есть то подставляем иконку.

##### Первая строка

Для составления первой строки используется поле `title` либо `markup.title` если определено.

##### Вторая строка

Для составления второй строки используется поля `title`, `markup.title`, `id`, `driver`.

Если поле `markup.title`, определено, то вторая строка будет состоять из `title`.

Если поле `markup.title`, НЕ определено, то вторая строка составляется из полей `id`, `driver`.

Если есть поля `id`, `driver` то выводим `${id} (${driver})`.

Если поля `driver` нет или оно `UNSPECIFIED` или совпадает с `id`, то выводим просто `id`.

#### Тело

Первым делом в теле карточки выводится описание `markup.description`, если определено, если нет, то опускается.

Далее выводится `labels` выводятся как теги, на которые можно дважды кликнуть, и установится фильтр по лейблу, в следствии чего страница будет отфильтрована.

Далее выводится время последнего изменения данных любого из контролов устройства и данная с точка отмечается цветовым индикатором, который дает понять на сколько свежие данные в устройстве.

Далее выводится количество контролов в данном устройстве.

Далее мы показываем состояние устройства, исправное или нет, если есть данные в поле `error`, то устройство не исправное, и появляется возможность скачать данные ошибки в буфер обмена.

Далее мы даем кнопку по которой можно открыть popUp с `meta` информацией если это поле определено.

По низу карточки, должна быть кнопка для открытия устройства, для детального просмотра, и изменения состояния контролов, а так же перехода в режим разметки устройства и контролов.

Устройство открывается как `оверлей` над списком устройств.

На странице устройства, выводится вся та же информация, что и на карточке устройства, заголовок оформлен так же, и структура следования данных такая же, но в карточке устройства, доступен список контролов, где можно изменить их value, и так же перейти в режим разметки контрола.

### Страница устройства

Страница устройства выполняет несколько функций:

- Позволяет посмотреть информацию по имеющимся контролам
- Выполнить разметку устройства
- В ручном режиме изменить состояние какого либо контрола
- Выполнить разметку контролов

Заголовок страницы, оформляется так же как и заголовок карточки устройства.

Далее выводится вся так же информация, что и на карточке товара, но на странице уже можно редактировать поля:

- `markup.title`
- `markup.description`
- `labels`
- `markup.order` - можно задать число, и это будет учтено при фильтрации.
- `markup.color`

После чего можно переходить к спику контролов.

#### Список контролов

- `id`, если указан `markup.title`, то `${markup.title} (${id})`.
- `type`, исходя из которого мы понимаем какой UI элемент использовать для быстрого изменения значения (input, switch, button, range, color).
  - По `type` мы можем поставить иконку.
- `value`, текущее значение + иконка для перехода на страницу просмотра исторических данных.
  - [Страница вывода исторических данных, это отдельная страница, которая позволяет просматривать данные по нескольким контролам, нескольких устройств](./history.md), при переходе на страницу, выставляется фильтр по этому контролу, за последние 3 суток.
- `readonly`, в случае если контрол только для чтения, то быстрое изменение параметра не доступно.
- `labels`, выводим список лейблов.
  - Лейблы можно добавить прям на месте, с использованием автокомплита по имеющимся лейблам.
- Выводим прошедшее время с последнего изменения и цветовую индикацию, для быстрого понимания, какие контролы меняются часто, а какие нет.
- `error`
  - если там, что-то есть то показываем информацию,о том, что контрол сломан, и можно скачать в буфер обмена информацию о ошибке.
  - если нет, то показываем, что контрол здоров.
- `meta`
  - если там, что-то есть то пишем, что доступна мета информация, и даем кнопку для просмотра в popUp окне, а уже в этом окне кнопка для копирования самой мета информации в буфер обмена.
- `markup.color`, если определено, то нужно отметить контрол таким цветом.
- `markup.order`, если определено, то нужно учитывать при сортировки.
- Ручка для перетаскивая вверх и вниз по списку, в результате будет меняться `markup.order`. **(опционально)**
- Кнопка для запуска режима разметки контрола.

#### Разметка контрола

При разметке контрола, можно:

- Менять `markup.title`
- Менять `markup.description`
- Менять `labels`
- Менять `markup.color`
- Менять `markup.order` - будет учитываться при сортировке.
- Сохранить изменения, и вернуться к редактированию устройства.

При работе с контролами, нет необходимости дублировать лейблы из устройства, так как поиск контролов будет происходит в рамках устройств.

## Пагинация

См. [pagination](./pagination.md).

## Сценарий использования

Страница устройств используется только в начале пусконаладочных работ, для того, чтобы разметить все устройства, и в дальнейшем, чтобы скорректировать разметку.

Так же страница будет использована для просмотра данных в реальном времени, а так же исторических данных для каждого контрола.
